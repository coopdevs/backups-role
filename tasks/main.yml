---
- name: Ensure group for backups user exists
  group:
    name: "{{ backups_role_user_group }}"
    state: present

- name: Ensure restricted user for backups exists
  user:
    name: "{{ backups_role_user_name }}"
    group: "{{ backups_role_user_group }}"
    system: true
    state: present
  when: backups_role_user_name != 'root'

- name: Ensure directory for backup script exists
  file:
    path: "{{ backups_role_script_path }}"
    state: directory
    owner: "{{ backups_role_user_name }}"
    group: "{{ backups_role_user_group }}"
    mode: 0775

- name: Install backup script "prepare"
  template:
    src: "{{ backups_role_script_prepare_template }}"
    dest: "{{ backups_role_script_prepare }}"
    owner: "{{ backups_role_user_name }}"
    group: "{{ backups_role_user_group }}"
    mode: 0775

- name: Install backup script "upload"
  template:
    src: "cron-upload.sh.j2"
    dest: "{{ backups_role_script_upload }}"
    owner: "{{ backups_role_user_name }}"
    group: "{{ backups_role_user_group }}"
    mode: 0775

- name: Install backup script "main"
  template:
    src: "cron-main.sh.j2"
    dest: "{{ backups_role_script_main }}"
    owner: "{{ backups_role_user_name }}"
    group: "{{ backups_role_user_group }}"
    mode: 0775

- name: Ensure directory for backups temporary data exists
  file:
    path: "{{ backups_role_tmp_path }}"
    state: directory
    owner: "{{ backups_role_user_name }}"
    group: "{{ backups_role_user_group }}"
    mode: 0775

- name: Ensure postgresql "role" for backups exists with limited access to db
  postgresql_user:
    db: "{{ backups_role_db_name }}"
    name: "{{ backups_role_postgresql_user_name }}"
    password: "{{ backups_role_postgresql_user_password }}"
    # This provides '{{ name  }}=c/{{ become_user }}' in {{ db }} database
    # Plus any other access it can have through privileges granted to PUBLIC
    # This `priv` key is not flexible enough to grant SELECT priv on *any* table
    # inside database. Thus, we do it in two steps.
    priv: "CONNECT"
  become: true
  become_user: "{{ postgresql_user }}"

- name: Ensure postgresql "role" for backups has "select" access to any table in {{ backups_role_db_name }}
  postgresql_privs:
    db: "{{ backups_role_db_name }}"
    role: "{{ backups_role_postgresql_user_name }}"
    objs: ALL_IN_SCHEMA
    # This ensures that this priv exists: {{ role }}=r/{{ become_user }}
    privs: SELECT
  become: true
  become_user: "{{ postgresql_user }}"

- name: Ensure postgresql "role" for backups has no other access to any table in {{ backups_role_db_name }}
  postgresql_privs:
    db: "{{ backups_role_db_name }}"
    role: "{{ backups_role_postgresql_user_name }}"
    objs: ALL_IN_SCHEMA
    # Revoke all privs except SELECT
    # https://www.postgresql.org/docs/current/sql-grant.html
    privs: "INSERT,UPDATE,DELETE,TRUNCATE,REFERENCES,TRIGGER"
    state: absent
  become: true
  become_user: "{{ postgresql_user }}"

- name: Let backup user to use `{{ backups_role_sudoers_cmd_pattern }}` as root
  template:
    src: "sudoers.j2"
    dest: "/etc/sudoers.d/90-backup-user"
    mode: 0440
    group: "root"

- name: Install restic and configure restic repository
  include_role:
    name: vendor/paulfantom.restic
  vars:
    restic_version: "{{ backups_role_restic_version }}"
    restic_user: "{{ backups_role_user_name }}"
    restic_group: "{{ backups_role_user_group }}"
    restic_cron_stdout_file: "{{ backups_role_cron_stdout_file }}"
    restic_cron_stderr_file: "{{ backups_role_cron_stderr_file }}"
    restic_repos:
      - name: "{{ backups_role_restic_repo_name }}"
        url: "{{ backups_role_restic_repo_url }}"
        password: "{{ backups_role_restic_repo_password }}"
        remote_credentials:
          # See README.md for an explanation
          # restic takes app or account credentials indistinctly
          b2_account_id: "{{ backups_role_b2_app_key_id }}"
          b2_account_key: "{{ backups_role_b2_app_key }}"
        jobs:
          - command: "{{ backups_role_script_main }}"
            at: "{{ backups_role_cron_job_at }}"
            user: "{{ backups_role_user_name }}"
