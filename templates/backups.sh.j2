#!/bin/bash

# Backup git revision
# pushd /home/git_repo/current
# git rev-parse --verify HEAD > {{ backups_role_last_backup_path }}/git_rev
# popd

# Exit with error code 1 if any command fails
set -e

# NOTE
# This script is meant to be executed by a very limited sudoer user.
# It must be allowed to only execute `tar -czvf *` as root,
# meaning that it can't uncompress, add options, or even change the options order.
# This is a way to give to this user read-only access to whole filesystem.

echo "## Postgres DB dump ##"
/usr/bin/pg_dump --encoding=UTF8 {{ backups_role_db_name }} > {{ backups_role_last_backup_path }}/pg_dump

echo "## Compress configuration files ##"
sudo tar -czvf {{ backups_role_last_backup_path }}/config.tar.gz {{ backups_role_config_paths|join(' ') }}

echo "## Compress assets data ##"
sudo tar -czvf {{ backups_role_last_backup_path }}/assets.tar.gz {{ backups_role_assets_paths|join(' ') }}

echo "## Restic backup ##"
restic backup \
	{{ backups_role_last_backup_path }}/pg_dump \
	{{ backups_role_last_backup_path }}/config.tar.gz \
	{{ backups_role_assets_paths|join(' ') }}

echo "## Restic forget ##"
restic forget --keep-last 5 --prune

echo "## Restic check ##"
restic check

echo "## Remove temporal files ##"
rm -rf "{{ backups_role_last_backup_path  }}"
